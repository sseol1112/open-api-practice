<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Practice</title>    
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://code.jquery.com/jquery-3.6.3.js"></script>
    <!-- <script src="../js/search.js"></script> -->
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>OPEN API Practice.</h1>
            <h3>Chapter 1. Search :: ğŸ”âœ¨</h3>
        </div>
        <div class="contents">
            <div class="form-wrap">
                <h5>ê²€ìƒ‰í•˜ê³ ì í•˜ëŠ” ë„ì„œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</h5>
                <div class="search-form">
                    <input type="text" value="" name="search" class="input-search" placeholder="ì±…ì œëª© ì…ë ¥">
                    <button class="btn btn-search">ê²€ìƒ‰</button>
                    <button class="btn btn-reset ml10">ì´ˆê¸°í™”</button>
                </div>
            </div>
            <div class="result-wrap">
                <div class="result-list">
                    <ul>
                    </ul>
                </div>
            </div>
            <div class="pagination">
                <div class="arrow-wrap">
                    <a href="javascript:activePaging('prev');" class="prev arr">ì´ì „</a>
                    <ul class="paging"></ul>
                    <a href="javascript:activePaging('next');" class="next arr">ë‹¤ìŒ</a>

                </div>
            </div>
        </div>
        <div class="footer fl-center">
            <div class="btn-wrap">
                <a class="btn" href="../index.html">ëª©ë¡ ë³´ê¸°</a>
            </div>
        </div>

    </div>    
</body>
<script>

    // ì¹´ì¹´ì˜¤ Open API í™œìš© (https://developers.kakao.com/) 

    // OPEN APIë¥¼ ì‚¬ìš©í•˜ë ¤ë©´, ì¸ì¦í‚¤ë¥¼ ë¨¼ì € ë°œê¸‰ë°›ì•„ì•¼í•¨.
    // ê·¸ í›„ ê³µì‹ë¬¸ì„œ ì ˆì°¨ë¥¼ ë”°ë¥´ë©´ ë¨
    let inputSearch = document.querySelector(".input-search");
    let inputValue = '';
    let btnSearch = document.querySelector(".search-form .btn-search");     
    let btnReset = document.querySelector(".search-form .btn-reset");     
    let pagination = document.querySelector(".pagination");
    let curStart = '';
    let curEnd = '';
    
    // í‚¤ë³´ë“œ Enter ëˆ„ë¥¼ ê²½ìš°, ì²˜ë¦¬í•˜ê¸° ìœ„í•¨
    inputSearch.addEventListener('keypress', function(e) {
        if(e.keyCode === 13) {
            getBookInfo();
        }
    });

    // ê²€ìƒ‰ë²„íŠ¼ í´ë¦­ì‹œ,
    btnSearch.addEventListener('click', function() {
        getBookInfo('', 1);
    });

    // ì´ˆê¸°í™”ë²„íŠ¼ í´ë¦­ì‹œ,
    btnReset.addEventListener('click', function() {
        resultReset();
        pagination.style.display = "none";
    });
    
    
    
    function getBookInfo (inputValue, pageNum) {

        const KAKAO_API_KEY = "15c5d3c0331e75e1db22a54afe24971c"; //Kakaoì—ì„œ ë°œê¸‰ë°›ì€ API ì¸ì¦í‚¤

        inputValue = document.querySelector('.input-search').value; //ê²€ìƒ‰ì°½ì— ì…ë ¥í•œ ê°’ ì €ì¥í•˜ê¸° ìœ„í•œ ë³€ìˆ˜           

        // api í˜¸ì¶œì„ ìœ„í•œ $.ajax() í•¨ìˆ˜ ì‚¬ìš© (ë¹„ë™ê¸° í†µì‹ )
        $.ajax({
            method: "GET", // ê°’ì„ ì–»ì–´ì™€ì•¼ í•¨ìœ¼ë¡œ, GETë°©ì‹
            url: "https://dapi.kakao.com/v3/search/book",
            data : {
                query : inputValue,
                page : pageNum,
                "is_end": true,
                "pageable_count": 9,
                "total_count": 10
            },
            headers : {
                Authorization : "KakaoAK " + KAKAO_API_KEY // ê³µí†µìœ¼ë¡œ ìš”ì²­ í•  í—¤ë”
            },
            success : function(data){ //api í˜¸ì¶œ ì„±ê³µì‹œ, í•˜ë‹¨ ë‚´ìš© ì‹¤í–‰
                // ì„±ê³µì‹œ ì–»ì€ ë°ì´í„° ê°’ì˜ ê¸¸ì´ ë§Œí¼ ë™ì ìœ¼ë¡œ ë§ˆí¬ì—… ìƒì„±í•˜ì—¬ ê²°ê³¼ê°’ ë¦¬ìŠ¤íŠ¸ í˜•íƒœë¡œ ë³´ì´ë„ë¡ êµ¬í˜„í•˜ì˜€ìŒ.
                console.log(data);
                const searchResult = data.documents;
                const searchMeta = data.meta;
                let html = '';
                
                setPaging(searchMeta,0,10);
                for(let i=0; i<searchResult.length; i++) {
                    const title = searchResult[i].title;
                    const image = searchResult[i].thumbnail;
                    const author = searchResult[i].authors;
                    const publisher = searchResult[i].publisher;
                    const status = searchResult[i].status;
                    const content = searchResult[i].contents;
                    const price = searchResult[i].price;
                    const salePrice = searchResult[i].sale_price;

                    html += '<li>';
                    html +=     '<div class="thumbs">';
                    if(image.length > 0){
                    html +=         '<img src="'+image+'" alt="">';
                    }else{
                    html +=         '<img src="https://www.lge.co.kr/lg5-common/images/icons/noimage.svg" alt="no-image">';
                    }
                    html +=     '</div>';
                    html +=     '<div class="text-wrap">';
                    html +=         '<div class="info">';                    
                    html +=            '<div class="info-head">';
                    html +=              '<h4 class="title">'+title+'</h4>';
                    html +=              '<p class="status fc-red">'+status+'</p>';
                    html +=              '<p class="price"><span>'+price+'</span>'+salePrice+'ì›</p>';
                    html +=            '</div>'
                    html +=            '<span class="author">'+author+'</span>';
                    html +=            '<em class="publisher">'+publisher+'</em>';
                    html +=         '</div>';
                    html +=         '<div class="contents">';
                    html +=            '<p>'+content+'</p>';
                    html +=         '</div>';
                    html +=     '</div>';
                    html += '</li>';
                }
                document.querySelector(".result-wrap").style.marginTop = "16px";
                document.querySelector('.result-wrap .result-list ul').innerHTML = html;

                if(searchMeta.is_end === true){
                    document.querySelector(".next").classList.add("disabled");
                } else {
                    document.querySelector(".next").classList.remove("disabled");
                }
                
            },
            error : function(request,status,error) { //api í˜¸ì¶œ ì—ëŸ¬ì‹œ, í•˜ë‹¨ ë‚´ìš© ì‹¤í–‰
                console.log("code: " + request.status)
                console.log("message: " + request.responseText)
                console.log("error: " + error);
                if(request.status = 400) {
                    alert("400 error! ì…ë ¥ ê°’ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.");
                }
            }
        })        

    }

    // ê²°ê³¼ê°’ ì´ˆê¸°í™”
    function resultReset () {
        document.querySelector(".result-wrap").style.marginTop = "350px";
        document.querySelector('.input-search').value = "";
        document.querySelector('.result-wrap .result-list ul').innerHTML = '';
        // $('.result-wrap .result-list ul').html('');
    }

    setPaging = (meta,start,last) => {
        //ë§ˆì§€ë§‰í˜ì´ì§€ê°€ ì•„ë‹ê²½ìš°, í˜ì´ì§•ê·¸ë ¤ì¤Œ
        let pagingCount = meta.pageable_count/10;
        let paging = document.querySelector(".paging");
        let html = '';

        for(var i=start; i<last; i++){
            html += '<li><a href="javascript:chkPaging();" class="page">'+ (i+1) +'</a></li>';
        }
        
        paging.innerHTML = html;
        pagination.style.display = "flex";
        
        curStart = start;
        curEnd = last;
        // if(meta.is_end == false) {
        //     for(var i=start; i<last; i++){
        //         html += '<li><a href="javascript:chkPaging();" class="page">'+ (i+1) +'</a></li>';
        //     }
            
        //     paging.innerHTML = html;
        //     pagination.style.display = "flex";
            
        //     curStart = start;
        //     curEnd = last;
        // } else {
        //     console.log("ë§ˆì§€ë§‰ í˜ì´ì§€ì…ë‹ˆë‹¤.")
        // }
    }
    
    chkPaging = () => {
        let pageIdx = document.querySelectorAll('.paging .page');
        inputValue = document.querySelector('.input-search').value;
        for(var i =0; i < pageIdx.length; i++){
            pageIdx[i].addEventListener('click', function(e){
            var idx = e.target;
            var pageNum = idx.innerText;

            getBookInfo(inputValue, pageNum);

            });
        }
    }

    activePaging = (param) => {
        if(param ='next') {
            curStart += 10;
            curEnd += 10;
            setPaging('',curStart,curEnd);
        } else {
            curStart -= 10;
            curEnd -= 10;
            setPaging('',curStart,curEnd);
        }
    }
</script>
</html>